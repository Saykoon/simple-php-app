name: Deploy PHP Application to Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create production config
      run: |
        cat > config.php << 'EOF'
        <?php
        // Production database configuration
        define('DB_HOST', '${{ secrets.DB_HOST }}');
        define('DB_PORT', '${{ secrets.DB_PORT }}');
        define('DB_NAME', '${{ secrets.DB_NAME }}');
        define('DB_USER', '${{ secrets.DB_USER }}');
        define('DB_PASS', '${{ secrets.DB_PASSWORD }}');

        // Create database connection
        function getConnection() {
            try {
                $pdo = new PDO(
                    "mysql:host=" . DB_HOST . ";port=" . DB_PORT . ";dbname=" . DB_NAME . ";charset=utf8",
                    DB_USER,
                    DB_PASS,
                    [
                        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                        PDO::ATTR_TIMEOUT => 10
                    ]
                );
                return $pdo;
            } catch (PDOException $e) {
                die("Database connection failed: " . $e->getMessage());
            }
        }
        ?>
        EOF
    
    - name: Debug SSH key format
      run: |
        echo "Checking SSH key format..."
        if [[ "${{ secrets.PRIVATE_SSH_KEY }}" == *"-----BEGIN"* ]]; then
          echo "✅ SSH key starts correctly"
        else
          echo "❌ SSH key does not start with -----BEGIN"
        fi
        if [[ "${{ secrets.PRIVATE_SSH_KEY }}" == *"-----END"* ]]; then
          echo "✅ SSH key ends correctly" 
        else
          echo "❌ SSH key does not end with -----END"
        fi
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.PRIVATE_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE || '' }}
        source: "./"
        target: "/var/www/html/simple-php-app"
        overwrite: true
        rm: false
        strip_components: 0
    
    - name: Set permissions and setup database
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.PRIVATE_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE || '' }}
        script: |
          echo "=== CHECKING FILE LOCATIONS ==="
          echo "Contents of /var/www/vc:"
          ls -la /var/www/vc/ 2>/dev/null || echo "Directory /var/www/vc does not exist"
          
          echo "Contents of /var/www/vc/simple-php-app:"
          ls -la /var/www/vc/simple-php-app/ 2>/dev/null || echo "Directory /var/www/vc/simple-php-app does not exist"
          
          echo "Contents of /var/www/html:"
          ls -la /var/www/html/ 2>/dev/null || echo "Directory /var/www/html does not exist"
          
          echo "Apache document root:"
          apache2ctl -S 2>/dev/null | grep DocumentRoot || echo "Could not determine Apache DocumentRoot"
          
          echo "=== SETTING UP APPLICATION ==="
          cd /var/www/html/simple-php-app 2>/dev/null || cd /var/www/vc/simple-php-app 2>/dev/null || echo "Could not find application directory"
          pwd
          chmod -R 755 . 2>/dev/null || echo "Permissions set as much as possible"
          
          echo "=== TESTING DATABASE CONNECTION ==="
          echo "Testing connection to ${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}"
          nc -zv ${{ secrets.DB_HOST }} ${{ secrets.DB_PORT }} 2>&1 || echo "Cannot connect to database server"
          
          echo "=== CHECKING CONFIG.PHP ==="
          cat config.php | head -10
          
          mysql -h ${{ secrets.DB_HOST }} -P ${{ secrets.DB_PORT }} -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} < database.sql 2>/dev/null || echo "Database setup: tables may already exist"
          echo "Deployment completed successfully!"
          echo "Try these URLs:"
          echo "- http://${{ secrets.SERVER_HOST }}/simple-php-app/"
          echo "- http://${{ secrets.SERVER_HOST }}/vc/simple-php-app/"
          echo "- http://${{ secrets.SERVER_HOST }}:8080/simple-php-app/"