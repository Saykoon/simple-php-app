name: Deploy PHP App to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Create production config
      run: |
        cat > config.php << 'EOF'
        <?php
        // Production database configuration (Google Cloud SQL)
        define('DB_HOST', '${{ secrets.DB_HOST }}');
        define('DB_NAME', '${{ secrets.DB_NAME }}');
        define('DB_USER', '${{ secrets.DB_USER }}');
        define('DB_PASS', '${{ secrets.DB_PASSWORD }}');

        // Create database connection
        function getConnection() {
            try {
                $pdo = new PDO(
                    "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8",
                    DB_USER,
                    DB_PASS,
                    [
                        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                        PDO::ATTR_TIMEOUT => 15
                    ]
                );
                return $pdo;
            } catch (PDOException $e) {
                die("Database connection failed: " . $e->getMessage());
            }
        }
        ?>
        EOF
    
    - name: Copy artifact to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.PRIVATE_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        source: "./"
        target: "/var/www/html/simple-php-app"
        overwrite: true
        rm: false
        strip_components: 0
    
    - name: Set permissions
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.PRIVATE_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          cd /var/www/html/simple-php-app
          chmod -R 755 .
          echo "Deployment completed successfully!"