name: Deploy PHP Application to Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create production config
      run: |
        cat > config.php << 'EOF'
        <?php
        // Production database configuration
        define('DB_HOST', '${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}');
        define('DB_NAME', '${{ secrets.DB_NAME }}');
        define('DB_USER', '${{ secrets.DB_USER }}');
        define('DB_PASS', '${{ secrets.DB_PASSWORD }}');

        // Create database connection
        function getConnection() {
            try {
                $pdo = new PDO(
                    "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8",
                    DB_USER,
                    DB_PASS,
                    [
                        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
                    ]
                );
                return $pdo;
            } catch (PDOException $e) {
                die("Database connection failed: " . $e->getMessage());
            }
        }
        ?>
        EOF
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.PRIVATE_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        source: "./"
        target: "/var/www/vc/simple-php-app"
        overwrite: true
        rm: false
    
    - name: Set permissions and setup database
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.PRIVATE_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          cd /var/www/vc/simple-php-app
          chmod -R 755 . 2>/dev/null || echo "Permissions set as much as possible"
          mysql -h ${{ secrets.DB_HOST }} -P ${{ secrets.DB_PORT }} -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} < database.sql 2>/dev/null || echo "Database setup: tables may already exist"
          echo "Deployment completed successfully!"
          echo "Application should be available at: http://${{ secrets.SERVER_HOST }}/simple-php-app/"