name: Deploy PHP App (No SSH)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  prepare-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        
        # Create production config
        cat > config.php << EOF
        <?php
        // Production database configuration
        define('DB_HOST', '${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}');
        define('DB_NAME', '${{ secrets.DB_NAME }}');
        define('DB_USER', '${{ secrets.DB_USER }}');
        define('DB_PASS', '${{ secrets.DB_PASSWORD }}');

        function getConnection() {
            try {
                \$pdo = new PDO(
                    "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8",
                    DB_USER,
                    DB_PASS,
                    [
                        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
                    ]
                );
                return \$pdo;
            } catch (PDOException \$e) {
                die("Database connection failed: " . \$e->getMessage());
            }
        }
        ?>
        EOF
        
        # Create deployment archive
        zip -r simple-php-app.zip . -x "*.git*" "*.github*" "README.md" "SSH_SETUP.md" "deploy.sh"
        
        echo "âœ… Deployment package created: simple-php-app.zip"
        ls -la simple-php-app.zip
    
    - name: Upload deployment package
      uses: actions/upload-artifact@v3
      with:
        name: php-app-deployment
        path: simple-php-app.zip
    
    - name: Deployment Instructions
      run: |
        echo "ðŸŽ¯ MANUAL DEPLOYMENT INSTRUCTIONS:"
        echo "=================================="
        echo "1. Download the deployment package from GitHub Actions artifacts"
        echo "2. Upload simple-php-app.zip to your server"
        echo "3. Extract it to /var/www/vc/simple-php-app/"
        echo "4. Run: mysql -h ${{ secrets.DB_HOST }} -P ${{ secrets.DB_PORT }} -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} < database.sql"
        echo "5. Set file permissions: chmod -R 755 /var/www/vc/simple-php-app"
        echo "6. Application will be available at: http://${{ secrets.SERVER_HOST }}/simple-php-app/"
        echo ""
        echo "ðŸ“‹ Database config is already set for production"
        echo "ðŸ”§ All files are ready for deployment"